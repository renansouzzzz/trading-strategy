parametro
  MediaCurta(20);
  MediaLonga(200);
  PeriodoTopFundo(4);

var
  precoMaximoDia, precoMinimoDia: Real;
  precoAtual: Real;
  medCurta, medLonga, vwap: Real;
  sentimentoAmplitude: Real;
  retornoNivel: Real;
  precoEntrada, stopLoss, takeProfit: Real;
  sentimentoDetectado, retornoDetectado: Boolean;
  topoPeriodo, fundoPeriodo, ultimoTopo: Real;
  volumeAtual, volumeMedio, volumeAcumulado: Real;
  numCandles: Integer;

begin
  precoMaximoDia := HighD(0);
  precoMinimoDia := LowD(0);
  precoAtual := Close;
  medCurta := Media(MediaCurta, Close);
  medLonga := Media(MediaLonga, Close);
  vwap := VWAP;

  topoPeriodo := Highest(High, PeriodoTopFundo);
  fundoPeriodo := Lowest(Low, PeriodoTopFundo);

  sentimentoAmplitude := precoMaximoDia - precoMinimoDia;

  retornoNivel := precoMaximoDia - (sentimentoAmplitude * 0.5);

  sentimentoDetectado := (sentimentoAmplitude >= 600) and (sentimentoAmplitude <= 800);
  retornoDetectado := (precoAtual <= retornoNivel);//(precoAtual >= retornoNivel * 0.95) and (precoAtual <= retornoNivel * 1.05);
  volumeAtual := Volume;
  volumeAcumulado := VolumeD(0); // Volume financeiro total do dia

  // Incrementa o número de candles
  numCandles := CurrentBar + 1; // A variável CurrentBar geralmente indica o número do candle atual (começa em 0)

  // Calcula a média do volume financeiro até o momento
  volumeMedio := volumeAcumulado / numCandles;

  if precoAtual > topoPeriodo then
  begin
    ultimoTopo := topoPeriodo;
  end;

  if sentimentoDetectado 
     and retornoDetectado 
     and (precoAtual > medLonga)
     and (volumeAtual > volumeMedio)
     and (precoAtual > ultimoTopo)
     and not IsBought 
  then
  begin
    BuyAtMarket;
    precoEntrada := precoAtual;
    stopLoss := fundoPeriodo;
    takeProfit := precoEntrada + 300;
    PaintBar(clGreen);
  end;

  if IsBought then
  begin
    if (precoAtual <= stopLoss) then
    begin
      SellToCoverAtMarket;
    end
    else if (precoAtual >= takeProfit) then
    begin
      SellToCoverAtMarket;
    end;
  end;
end;
